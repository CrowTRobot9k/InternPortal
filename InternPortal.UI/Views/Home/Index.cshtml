@model InternPortal.UI.ViewModels.HomePageViewModel

@{
    ViewBag.Title = "Home Page";
    ViewBag.Decription = "";
}

<div class="container-fluid">
    @if (!User.IsInRole("admin"))
    {
        <div class="text-center">
            <h2>Welcome to Intern Portal</h2>
        </div>
        <hr>
        if (Model.User == null || Model.User.Applications.FirstOrDefault(i => i.ApplicationCompleteDate == null) == null)
        {
            <div class="row">
                <div class="text-center">
                    <div class="form-group">
                        <label for="exampleInputPassword1">Start Application:</label>
                        @Html.ActionLink("Start", "Application", "Application", null, new { @class = "btn btn-primary" })
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="text-center">
                    <div class="form-group">
                        <label for="exampleInputPassword1">Continue Application:</label>
                        @Html.ActionLink("Continue", "Application", "Application", null, new { @class = "btn btn-primary" })
                    </div>
                </div>
            </div>
        }

        <div class="text-center">
            <h3>Your Submitted Applications</h3>
        </div>
        <div>
            <div id="UserApplicationGrid"></div>
        </div>

    }
    else
    {
        <div class="text-center">
            <h2>Submitted Applications</h2>
        </div>
        <hr>
        //Admin Grid
        <div>
            <div id="ApplicationGrid"></div>

            <script type="text/x-kendo-template" id="ApplicationTemplate">
                <div class="tabstrip">
                    <ul>
                        <li id="ApplicationProfileTab" class="k-state-active">
                            Profile
                        </li>
                        <li id="ApplicationQuestionsTab">
                            Questions
                        </li>
                        <li id="ApplicationUploadsTab">
                            Uploads
                        </li>
                        <li id="ApplicationNotesTab">
                            Notes
                        </li>
                    </ul>
                    <div>
                        <div class='ApplicationProfile col-lg-12 col-md-12'>
                            <label>Name </label> #: User.FirstName # #: User.LastName #
                            <br>
                            <label>Email </label> #: checkNull(User.Email) #
                            <br>
                            <label>Phone: </label>#: checkNull(User.PhoneNumber) #
                            <br>
                            <label>Address:</label><address>
                                #: checkNull(User.Address) #<br />
                                #: checkNull(User.City) #, #: checkNull(User.State) #, #: checkNull(User.ZipCode) #
                            </address>
                            <label>DOB: </label> #: formatDate(User.DateOfBirth) #
                            <br><label>Gender: </label> #: checkNull(User.Gender) #
                            <br>
                            <label>Ethnicity: </label> #: checkNull(User.Ethnicity) #
                        </div>
                    </div>
                    <div>
                        <div class="ApplicationQuestions"></div>
                    </div>
                    <div>
                        <div class="ApplicationUploads col-lg-12 col-md-12">
                            # if (UserUploads[0]!=null){ #
                            <label>Title: </label> #=UserUploads[0].UploadTitle #
                            <br>
                            <label>Description: </label> #= UserUploads[0].UploadDescription#
                            <form method="get" action="/Home/Downloadfile/#=UserUploads[0].UploadId#">
                                <button type="submit" class="k-button k-primary">Download</button>
                            </form>
                            #}
                            else
                            {#
                            <label>No Uploads Submitted</label>
                            #}#
                        </div>
                    </div>
                    <div>
                        <div class="ApplicationNotes"></div>
                    </div>
                </div>
            </script>
        </div>
    }
</div>

<script>
    function formatDate(data) {
        var date = kendo.toString(kendo.parseDate(data), "yyyy-MM-dd") || "N/A";
        return date;
    }
    //template to set columns to readonly on edit.
    function readOnly(container, options) {
        container.removeClass("k-edit-cell");

        if (options.field.toLowerCase().indexOf("date")>=0)
        {
            container.text(formatDate(options.model.get(options.field)));
        }
        else
        {
            container.text(checkNull(options.model.get(options.field)));
        }
    }

   
    function formatDateTime(data) {
        return kendo.toString(kendo.parseDate(data), "yyyy-MM-dd hh:mm") || "N/A";
    }
    function checkNull(data) {
        return data || "N/A";
    }

    var applicationStatuses = [];

     var applictaionStatusesUrl = "/API/InternService/GetApplicationStatuses";
    callService(applictaionStatusesUrl, function (response)
    {
            applicationStatuses = response;
    },
    function (error)
    {
            alert("Failed to get application statuses");
    });

    
    function getApplicationStatus(statusId)
    {
        var status= "";
        $.each(applicationStatuses, function (index, value) {
            if (statusId === value.ApplicationStatusId)
            {
                status = value.Status;
            }
        });

        return status;
    }

    function editApplication(e)
    {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var uri = '/Application/Application?applicationId=' + dataItem.ApplicationId;
        location.href = uri;
    }
   

    $(document).ready(function ()
    {

        var userAppDs = new kendo.data.DataSource({
            transport:
                {
                    read:
                        {
                            url: "/API/InternService/GetUserApplications"
                        }
                },
            schema:
                {
                    model:
                        {
                            id: "ApplicationId",
                            fields:
                                {
                                    ApplicationId: { type: "number" },
                                    UserID: { type: "number" },
                                    ApplicationStartDate: { type: "date" },
                                    ApplicationCompleteDate: { type: "date" },
                                    ApplicationStatusId: { type: "number" }
                                }


                        }
                },
            pageSize: 10
        }); 

        $('#UserApplicationGrid').kendoGrid({
            dataSource: userAppDs,
            pageable: true,
            sortable: true,
            filterable: true,
            columns: [
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Application Id",
                    field: "ApplicationId",
                    editor: readOnly,
                    type: "number",
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "First Name",
                    field: "User.FirstName",
                    type: "string",
                    editor: readOnly,
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Last Name",
                    field: "User.LastName",
                    type: "string",
                    editor: readOnly,
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Start Date",
                    field: "ApplicationStartDate",
                    template: '#= formatDate(ApplicationStartDate) #',
                    filterable: true,
                    editable: false,
                    editor: readOnly,
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Completed Date",
                    field: "ApplicationCompleteDate",
                    template: '#= formatDate(ApplicationCompleteDate) #',
                    filterable: true,
                    editor: readOnly,
                },
                {
                    headerAttributes: { "class": "column-header" }, field: "ApplicationStatusId", title: "Status",
                    template: '#= getApplicationStatus(ApplicationStatusId) #',
                    editor: applicationStatusEditor,
                    filterable: {
                        extra: false,
                        multi: true
                    }
                },
                {
                    command:
                    [
                            { text: "Edit", click: editApplication}
                    ],
                    title: " "
                }
            ]
        });

        var applicationDs = new kendo.data.DataSource({
            transport:
            {
                read:
                    {
                        url: "/API/InternService/GetApplications"
                    },
                update:
                    {
                        url: "/API/InternService/UpdateApplication",
                        type: "POST"

                    }
            },
            schema:
                {
                    model:
                        {
                            id: "ApplicationId",
                            fields:
                                {
                                    ApplicationId: { type: "number" },
                                    UserID: { type: "number" },
                                    ApplicationStartDate: { type: "date" },
                                    ApplicationCompleteDate: { type: "date" },
                                    ApplicationStatusId: { type: "number" }
                                }


                        }
                },
        pageSize: 10
        });

        $('#ApplicationGrid').kendoGrid({
            dataSource: applicationDs,
            pageable: true,
            sortable: true,
            filterable: true,
            toolbar: ["excel"],
            excel: {
                fileName: "Applications.xlsx",
                allPages: true,
                filterable: true
            }
            ,
           editable: "inline" 
            ,
            detailTemplate: kendo.template($("#ApplicationTemplate").html()),
            detailInit: detailInit,
            columns: [
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Application Id",
                    field: "ApplicationId",
                    editor: readOnly,
                    type: "number",
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "First Name",
                    field: "User.FirstName",
                    type: "string",
                    editor: readOnly,
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Last Name",
                    field: "User.LastName",
                    type: "string",
                    editor: readOnly,
                    filterable: {
                        extra: false,
                        multi: false,
                        operators: {
                            number: {
                                eq: "Equal to",
                                neq: "Not equal to"
                            }
                        }
                    }
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Start Date",
                    field: "ApplicationStartDate",
                    template: '#= formatDate(ApplicationStartDate) #',
                    filterable: true,
                    editable: false,
                    editor: readOnly,
                },
                {
                    headerAttributes: { "class": "column-header" },
                    title: "Completed Date",
                    field: "ApplicationCompleteDate",
                    template: '#= formatDate(ApplicationCompleteDate) #',
                    filterable: true,
                    editor: readOnly,
                },
                {
                    headerAttributes: { "class": "column-header" }, field: "ApplicationStatusId", title: "Status",
                    template: '#= getApplicationStatus(ApplicationStatusId) #',
                    editor:applicationStatusEditor,
                    filterable: {
                        extra: false,
                        multi: true
                    }
                },
                { command: ["edit"], title: "&nbsp;" }
            ]
        });


        function applicationStatusEditor(container, options) {
            $('<input required name="' + options.field + '"/>')
                .appendTo(container[0])
                .kendoDropDownList({
                    dataTextField: "Status",
                    dataValueField: "ApplicationStatusId",
                    dataSource: applicationStatuses
                });
        }

        function detailInit(e) {
            var detailRow = e.detailRow;

            var qaUri = "/API/InternService/GetApplicationAnswers/" + e.data.ApplicationId;

            detailRow.find(".tabstrip").kendoTabStrip({
                animation: {
                    open: { effects: "fadeIn" }
                }
            });

            window.record = 0;
            detailRow.find(".ApplicationQuestions").kendoGrid({
                dataSource: {
                    transport: { read: { url: qaUri } }
                },
                columns: [
                    {
                        title: "#",
                        template: "#= ++window.record #",
                        width: 40
                    },
                    { field: "QuestionId", title: "QuestionId", hidden: true },
                    { field: "Question", title: "Question" },
                    { field: "Answer", title: "Answer" }
                ],
                pageable: false,
                dataBinding: function () {
                    window.record = 0;
                }
            });

            var notesUri = "/API/InternService/GetApplicationNotes/" + e.data.ApplicationId;

            window.record = 0;
            detailRow.find(".ApplicationNotes").kendoGrid({
                dataSource: {
                    transport: {
                        read: { url: notesUri },
                        create: {
                            url: "/API/InternService/CreateNote",
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        },
                        update: {
                            url: "/API/InternService/UpdateNote",
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        },
                        destroy: {
                            url: "/API/InternService/DeleteNote",
                            type: "DELETE",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        },
                        
                        parameterMap: function (model, operation) {
                            if (operation !== "read" && model) {
                                return kendo.stringify(model);
                            }
                        }
                    },
                    schema:
                        {
                            model:
                                {
                                    id: "NoteId",
                                    fields:
                                        {
                                            NoteId: { type: "number" },
                                            ApplicationId: { type: "number", defaultValue: e.data.ApplicationId },
                                            UserId: { type: "string" },
                                            Note: { type: "string" }
                                        }
                                }
                        }
                },
                toolbar: ["create"],
                editable:
                {
                        mode: "inline"
                },
                columns: [
                    {
                        title: "#",
                        template: "#= ++window.record #",
                        width: 40
                    },
                    { field: "NoteId", title: "NoteId", hidden: true },
                    { field: "ApplicationId", title: "ApplicationId", hidden: true },
                    { field: "UserId", title: "UserId", hidden: true },
                    { field: "Note_", title: "Note" },
                    { command: ["edit", "destroy"], title: "&nbsp;" }
                ],
                pageable: false,
                dataBinding: function () {
                    window.record = 0;
                }
            });

        }
    });

    
</script>